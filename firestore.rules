rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper function to check if the user is the owner of the agent document.
     * The agent's document ID is the same as their authentication UID.
     */
    function isOwner(agentId) {
      return request.auth != null && request.auth.uid == agentId;
    }

    // Agent profiles
    match /agents/{agentId} {
      // Anyone can read agent profiles for the public website.
      allow read: if true;

      // Only the authenticated owner of the agent profile can create, update, or delete it.
      allow write: if isOwner(agentId);
    }

    // Properties are nested under agents, but we also want to query them globally.
    // The rule below allows anyone to read properties from any agent, which is necessary
    // for the global search page.
    match /agents/{agentId}/properties/{propertyId} {
      // Anyone can read property details for the public website.
      allow read: if true;
      
      // Only the authenticated owner can write (create, update, delete) properties.
      // This ensures that even though reads are public, only the agent can manage their listings.
      allow write: if isOwner(agentId);
    }

    // Leads can be created by anyone (from the contact form)
    // but should only be readable by the relevant agent (future enhancement).
    match /leads/{leadId} {
        allow create: if true;
        // For now, only authenticated users (agents) can see leads.
        // This should be refined to only allow the specific agent related to the lead.
        allow read, update, delete: if request.auth != null; 
    }
  }
}
