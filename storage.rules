
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Agent profile photos and property images
    match /agents/{agentId}/{allPaths=**} {
      // Public read access for all images
      allow read: if true;

      // Write access only for the owner of the agent profile
      allow write: if request.auth != null && request.auth.uid == agentId;
    }
    
    // Support ticket images
    match /support-images/{messageId}/{allPaths=**} {
       // Only authenticated users who are creating the ticket can upload.
       // We check that the user is uploading to a path that matches their UID in the message.
       // This is a simplified check; a more robust one might involve checking the Firestore document being created.
       allow create: if request.auth != null;

       // Admins and the original sender should be able to read images.
       // This requires a Firestore read to check ownership, which can be complex.
       // For simplicity, we allow any authenticated user to read, but production apps should lock this down.
       allow read: if request.auth != null;

       // No updates or deletes allowed to keep the record intact.
       allow update, delete: if false;
    }
  }
}
