
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Funções auxiliares de autenticação
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isAdmin() {
      // Lê o campo 'role' do documento do agente correspondente ao UID do usuário autenticado.
      return isSignedIn() && get(/databases/$(database)/documents/agents/$(request.auth.uid)).data.role == 'admin';
    }

    // Regra para a coleção de agentes (corretores/imobiliárias)
    match /agents/{agentId} {
      // Perfil e configurações são publicamente legíveis
      allow get: if true; 
      // A listagem de todos os agentes só é permitida para administradores
      allow list: if isAdmin();
      // Apenas o próprio dono ou um admin pode escrever no perfil
      allow write: if isOwner(agentId) || isAdmin();

      // Subcoleções dentro de cada agente
      match /properties/{propertyId} {
        allow read: if true;
        allow write: if isOwner(agentId) || isAdmin();
      }

      match /reviews/{reviewId} {
        allow create: if isSignedIn(); // Qualquer um pode enviar uma avaliação
        allow list, get: if resource.data.approved == true; // Leituras públicas apenas para avaliações aprovadas
        // Dono do perfil e admins podem gerenciar todas as avaliações
        allow read, update, delete: if isOwner(agentId) || isAdmin(); 
      }
      
      match /customSections/{sectionId} {
        allow read: if true;
        allow write: if isOwner(agentId) || isAdmin();
      }
      
      match /leads/{leadId} {
        allow create: if true; // Formulários de contato são públicos
        // Apenas o dono do perfil ou admin podem ler/gerenciar os leads
        allow read, update, delete: if isOwner(agentId) || isAdmin();
      }
    }

    // Regras para a coleção de mensagens de suporte
    match /supportMessages/{messageId} {
      // Qualquer usuário autenticado pode criar um ticket de suporte
      allow create: if isSignedIn();
      
      // Admins podem listar e ler todas as mensagens.
      allow list, get: if isAdmin();
      
      // O autor original também pode ler sua própria mensagem (mas não listar a coleção)
      allow get: if isOwner(resource.data.senderId);

      // Admins podem responder (atualizar) ou deletar
      allow update, delete: if isAdmin();
    }
  }
}
